/*!build time : 2013-11-04 4:04:45 PM*/
KISSY.add("gallery/contacts/1.0/index",function(a,b,c,d,e,f){"use strict";window.C={};var g,h={phonesbox:$("#phones .box"),getMorePhone:$("#getMore"),phonetmp:$("#phoneTmp"),showPhones:$("#showPhones .box"),sidebar:$("#sidebar"),selectNo:$("#toolbar em"),holder:$("#holder"),loading:$("#loading")},i=c.Model.extend({}),j=c.Model.extend({}),k=c.Collection.extend({model:i,initialize:function(){this.frag=document.createDocumentFragment(),this.bind("add",this.addOne,!1)},addOne:function(a,b,c){var d=new o({model:a}),e=d.render().$el;$(this.frag).append(e),c.index===b.length-1&&(h.getMorePhone.before(this.frag),h.getMorePhone.removeClass("hidden"),g&&clearTimeout(g),g=setTimeout(function(){C.phoneScroll.refresh()},100))},getModelByAttr:function(a){var b;return this.each(function(c,d){var e=c.get("phone");return e===a?(b={model:c,index:d},!1):void 0}),b}}),l=new k,m=c.Collection.extend({model:j,initialize:function(){this.bind("add",this.addOne,!1)},addOne:function(a){var b=new p({model:a});b.render()},_remove:function(a){var b;this.each(function(c,d){c.get("name")===a.name&&(b=d)}),this.at(b).destroy()},syncPhoneStatus:function(a){var b=a.name;l.each(function(a){return a.get("name")===b?(a.set("checked",!1),!1):void 0})}}),n=new m,o=c.View.extend({events:{tap:"statusToggle"},initialize:function(){var a=this.model;a.bind("change:checked",this.checkedStatus,this)},checkedStatus:function(){var a=this.model,b=a.get("checked"),c=this.$el.find(".checkbox");b?c.addClass("selected"):c.removeClass("selected")},render:function(){var a,c=this.model.toJSON();"undefined"!=typeof c.index?(this.$el.addClass("title"),a="<div><%= index %></div>"):(this.$el.addClass("phoneItem"),a=h.phonetmp.html());var d=b.template(a,c);return this.$el.html(d),this},statusToggle:function(){var a=n.length,b=this.model.get("index");if("undefined"==typeof b){var c=this.model.get("checked");if(c)this.model.set("checked",!1),n._remove(this.model.toJSON());else{var d=this.model.get("maxSelect");d>a?(this.model.set("checked",!0),n.add(this.model.toJSON())):new f({tip:"\u6700\u591a\u53ea\u80fd\u6dfb\u52a0"+d+"\u4f4d\u597d\u53cb",type:"alert"})}}}}),p=c.View.extend({tagName:"span",events:{click:"showDel",touchstart:"press",touchend:"press"},initialize:function(){this.model.bind("destroy",this.remove,this)},press:function(a){var b=$(a.currentTarget);b.toggleClass("press")},remove:function(){this.$el.remove(),h.selectNo.html(this.model.collection.length-1),this.autoZoom(),this.changeHolder(1)},showDel:function(){var a=this,b=this.model,c=b.toJSON();new f({onConfirm:function(){a.model.collection.syncPhoneStatus(c),b.destroy()},tip:"\u53d6\u6d88\u5bf9\u6b64\u4eba\u7684\u8d60\u9001?"})},render:function(){var a=this.model.toJSON(),c=b.template("<%= name %>",a);this.changeHolder(0),h.holder.before(this.$el.html(c)),h.selectNo.html(this.model.collection.length),this.autoZoom()},changeHolder:function(a){var b=(this.model,h.holder),c=this.model.collection.length;c>a?b.attr({placeholder:""}).val("").addClass("hidden").blur():b.attr({placeholder:"\u53ef\u8f93\u5165\u624b\u673a\u53f7\u7801"}).val("").removeClass("hidden").blur()},autoZoom:function(){for(var a=h.showPhones.find("span"),b=0,c=$("body").width(),e=a.length;e--;)b+=a.eq(e).width()+5;b+=45,C.phoneScroll.refresh(),b>c?(C.selectPhoneScroll.refresh(),C.selectPhoneScroll.scrollToElement(a[a.length-1])):C.selectPhoneScroll||(C.selectPhoneScroll=new d("showPhones",{vScrollbar:!1,bounce:!1}))}}),q=c.View.extend({el:"#wrap",pageIndex:0,events:{"click #sidebar li":"skipToIndex","click #showPhones":"showHolder","input #holder":"listen","click #delall":"delall","touchstart #delall":"press","touchend #delall":"press","touchstart #confirm":"press","touchend #confirm":"press","click #confirm":"done","click #getMore":"pushData"},initialize:function(a){var c=this,d="undefined"==typeof a.data?[]:a.data;this.pageSize="undefined"==typeof a.pageSize?50:a.pageSize;var e="undefined"==typeof a.preSelectArr?[]:a.preSelectArr;this.maxSelect="undefined"==typeof a.maxSelect?20:a.maxSelect;{var f=this.getPhoneDataNormal(d);this.normalData=f.normalData}this.buildPhoneScroll(),this.pushData(),b.delay(function(){c.prevSelectPhones(e)},0)},prevSelectPhones:function(a){a&&a.forEach(function(a){var b=!1;l.each(function(c,d){var e=c.get("phone");a===e&&(b=d)}),b?(l.at(b).set("checked",!0),n.add(l.at(b).toJSON())):n.add({name:a,phone:a})}),this.trigger("readAfter")},done:function(){return 0===n.length?(new f({tip:"\u60a8\u8fd8\u672a\u9009\u62e9\u8054\u7cfb\u4eba",type:"alert"}),void 0):(this.trigger("selectDone",n.toJSON()),void 0)},press:function(a){var b=$(a.currentTarget);b.toggleClass("press")},delall:function(){new f({onConfirm:function(){for(var a=n.length;a--;)n.syncPhoneStatus(n.at(a).toJSON()),n.at(a).destroy()},tip:"\u6e05\u7a7a\u6240\u6709\u5df2\u9009\u8054\u7cfb\u4eba?"})},listen:function(a){var b=$(a.currentTarget),c=b.val(),d={};if(11===c.length){var e=l.getModelByAttr(c);e?(d.name=e.model.get("name"),l.at(e.index).set("checked",!0)):d.name=c,d.phone=c,n.add(d)}},showHolder:function(a){var b=$(a.target);b.hasClass("box")&&h.holder.removeClass("hidden").attr("placeholder","\u53ef\u8f93\u5165\u624b\u673a\u53f7\u7801")},buildPhoneScroll:function(){C.phoneScroll=new d("phones",{vScrollbar:!1})},pushData:function(){var a=this,b=[],c=this.normalData;h.loading.addClass("hidden");var d=c.length,e=Math.ceil(d/this.pageSize),g=[];if(this.pageIndex>=e)return new f({tip:"\u6ca1\u6709\u66f4\u591a\u8054\u7cfb\u4eba",type:"alert"}),void 0;var i=c.slice(this.pageIndex*this.pageSize,(this.pageIndex++ +1)*this.pageSize);i.forEach(function(c){if("string"==typeof c)b.push({index:c}),g.push(c);else for(var d in c)b.push({name:d,phone:c[d],maxSelect:a.maxSelect})}),l.add(b),this.createIndex(g)},getPhoneDataNormal:function(b){var c=[],d={},f={},g=[],h=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];b.forEach(function(a){var b=new e,f=b.getFullChars(a.name[0]).toUpperCase();c.push(f[0]),"undefined"==typeof d[f[0]]&&(d[f[0]]={}),d[f[0]][a.name.length>6?a.name.substr(0,6):a.name]=a.phone}),c=a.unique(c),h.forEach(function(a){"undefined"!=typeof d[a]&&(f[a]=d[a]),c.indexOf(a)>=0&&g.push(a)});var i=[];for(var j in f){var k=f[j];i.push(j);for(var l in k){var m={};m[l]=k[l],i.push(m)}}return{normalData:i}},createIndex:function(b){var c="",d=h.sidebar;b.forEach(function(a){c+="<li>"+a+"</li>"}),d.append(c),d.css("height",a.one("body").height()-95+"px")},skipToIndex:function(a){for(var b,c=$(a.currentTarget).html(),d=h.phonesbox.find(".title"),e=d.length;e--;){var f=d.eq(e).find("div");if(f.html()===c){b=e;break}}C.phoneScroll.scrollToElement(d[b])}});return q},{requires:["gallery/gallery/contacts/1.0/underscore","gallery/gallery/contacts/1.0/backbone","gallery/gallery/contacts/1.0/iscroll","gallery/gallery/contacts/1.0/pinyin","gallery/gallery/contacts/1.0/confirm","base"]});